using Base
using HomotopyContinuation
using LinearAlgebra

@var d[1:48]
@var x1 x2 x3 x4 x5 x6 x7 x8

e0 = Transpose(reshape(d[1:9],3,3));
e1 = Transpose(reshape(d[10:18],3,3));
e2 = Transpose(reshape(d[19:27],3,3));
e3 = Transpose(reshape(d[28:36],3,3));
e4 = Transpose(reshape(d[37:45],3,3));
E = e0 + x1 * e1 + x2 * e2 + x3 * e3 + x4 * e4;
eqs = [2*(E*E')*E - tr(E*E')*E];
cubics = [eqs[1][1,1];eqs[1][1,2];eqs[1][1,3];eqs[1][2,1];eqs[1][2,2];eqs[1][2,3];eqs[1][3,1];eqs[1][3,2];eqs[1][3,3];det(E)]
p1 = [d[46];d[47];1];
p2 = [d[48];x8;1];
lin = Transpose(p2) * E * p1;
eqn = [cubics;lin];
J = differentiate(eqn,[x1,x2,x3,x4]);
Z = [x5;x6;x7;1];
eqnA = J * Z;
Eq = [eqn;eqnA];

F = System(Eq;variables=[x1,x2,x3,x4,x5,x6,x7,x8], parameters = d);
start_param = (rand(48) + rand(48) * im)
E_start = subs(Eq,d => start_param);
start_solution = solve(E_start);

real_data=[-0.03350260968150790830;0.03028826721693253163;-0.06983497020157503066;0.01648587762998767262;0.99313700359202894408;-0.02293466254164369666;0.02312810008112884189;-0.07367864939939351709;0.00096423488019172941;0.09768008798954494476;0.01120632021790486654;-0.25309582928994722728;-0.41584189197645615721;-0.01150169956266118565;0.81779930575893966527;0.10833856915486526906;-0.26882289857700908398;-0.02049514363214005250;-0.14974204370969890210;-0.84595310278393021086;-0.32797868320517453711;0.35915522634907992572;-0.01053676919266339530;0.08703076889704966512;0.12972529065716345564;-0.01714923793038220998;-0.02387570622023611408;-0.17060715733673814665;0.20111971027538780299;-0.77765862529928142521;-0.30908380049929606859;-0.06202979355899665426;-0.35597966590436891376;0.25412835604631789366;0.18208521353110407315;-0.04304489064843132484;-0.58856646485395680557;-0.31686421151214611003;0.35129169042286534363;-0.62719489328528199579;0.03655276587542505978;-0.07451162361035142123;-0.04608618231649048991;0.16551263082014425199;0.00092091318967275296;0.97233714902788126455;0.58086345937784045201;];

K=[2263.222656250000000000000000000000 0 502.500000000000000000000000000000;0 2263.222656250000000000000000000000 335.000000000000000000000000000000; 0 0 1]

#traverse Each column
A = [];
for i = 1:1000
    print(i)
    print("\n")
    temp = inv(K) * [i;0;1];
    tt = temp[1,1];
    r_data = [real_data;tt];
    E_target = solve(F, solutions(start_solution); start_parameters=start_param, target_parameters=r_data)
    SS = real_solutions(E_target);
    push!(A,SS);
end

curve_intersect = [];
for i = 1:1000
    one_sol = [];
    for j = 1:length(A[i])
        push!(one_sol,A[i][j][8]);
    end
    push!(curve_intersect,one_sol);
end

f = open("E_curve.txt","w");

for g in curve_intersect
    println(f,Transpose(g));
    #write(f,"\n");
end

close(f);
